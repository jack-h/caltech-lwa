# Test models for the ADS5296 / HMCAD1511 combined board

## Firmware Tool Versions:
- Ubuntu 16.04
- Xilinx ISE 14.7
- MATLAB/Simulink 2013b

The models in this directory require a modified version of mlib_devel with support for caltech's mixed HMCAD1511 / ADS5296 ZDOK test board.
This library version is available as submodule in this repository (`../mlib_devel_r2`).
The models here provide basic ADC testing capabilities.

## Test models
`ads5296_test.slx` -- A skeletal test design for the ADC board allowing short snapshots of ADC samples. This is sufficient for testing the ADC/FPGA link-training software.

`ads5296_test_mux.slx` -- A similar design to the basic test model, but adds the capability to synchronously snapshot 256k samples from any two of the 16 available ADC channels.

## Software
Testing software, written in Python2.7 (since it is based on the ancient `corr` module), can be found in the `software/` directory. It is not packaged for install, so scripts should be executed from this directory.

### Available scripts
#### `plot.py`

(use with `ads5296_test.slx`)
A simple, development-level script, for capturing data from ADCs and plotting spectra / samples.

#### `capture.py`

(use with `ads5296_test_mux.slx`
A parameterized script to capture dumps of 256k samples for either 1 or 2 ADC channels.

```
jackh@maze:~/src/caltech-lwa/ads5296_r2_tests/software$ python capture.py -h
usage: capture.py [-h] [-r ROACHHOST] [-b BOFFILE] [-p] [-A CHAN_A]
                  [-B CHAN_B] [-N N_DUMPS] [--mode MODE] [--sync] [--plot]

Write ADC sample data to files

optional arguments:
  -h, --help    show this help message and exit
  -r ROACHHOST  ROACH board to which connection should be made (default:
                r2d020669)
  -b BOFFILE    Boffile to program, if using the -p flag (default:
                ads5296_r2_test_mux_2020_Feb_26_0914.bof)
  -p            Program the ROACH board with the specified boffile (default:
                False)
  -A CHAN_A     First ADC channel to capture (allowed values: 0 through 15)
                (default: 8)
  -B CHAN_B     Second ADC channel to capture (allowed values: 0 through 15,
                or None) (default: None)
  -N N_DUMPS    Number of captures to dump to disk (default: 1)
  --mode MODE   'ramp', or 'adc'. Explicitly leave the ADC in ramp or normal
                mode (default: None)
  --sync        Toggle the sync pin on the ADS5296 chips (default: False)
  --plot        Plot data, rather than writing to disk (default: False)
```

**You must program your ROACH with this script (using the `-p` flag) to properly intialize the ADCs**

This script can be used to either plot spectra and ADC samples to screen with the `--plot` flag. Or to dump data to csv files.

Example usage:

1. Plot the first 1024 samples, and the 128k-point spectra of ADC channel 10 to screen:
```
python capture.py -A 10 --plot
```

2. Plot the first 1024, and the 128k-point spectra of ADC channels 10 and 11 to screen:
```
python capture.py -A 10 -B 11 --plot
```

3. Write a csv file containing 10 256k-sample dumps of ADC channels 8 and 9:
```
python capture.py -A 8 -B 9 -N 10
```

4. Plot the ramp output of ADCs 0 and 8, after issuing an ADC sync:
```
python capture.py -A 0 -B 8 --mode ramp --sync
```

Note that when capturing a dump of data from two channels takes approximately twice as long as capturing from a single channel.

Generated csv files have a two line header. The first line contains the time the dump script was launched, in python `time.ctime()` string representation. The second header line contains the ADC channels which were dumped, as a comma-separated list of ADC channels. For example, a header entry of `8,9` means that the csv file contains dumps for ADC channels 8 and 9.

Following the header, each line of the file represents a sequence of 256k ADC samples which were captured. Sequential lines cycle through multiple ADC channels (if a file contains more than one channel) and then through consecutive dumps. For example, a file generated with the command `python capture.py -N 4 -A 8 -B 9` might generate a file with the following contents:

```
Wed Feb 26 11:29:58 2020
8,9
4,2,-4,3, ... -10,13 # 256k ADC samples from the first dump of channel 8
5,-10,20, ... 14,-19 # 256k ADC samples from the first dump of channel 9
8,-7,12,  ... 19,20 # 256k ADC samples from the second dump of channel 8
5,-8,10,  ... 13,15 # 256k ADC samples from the second dump of channel 9
# etc.
```

#### `loadcsv.py`

This script serves as a simple example of how to read the csv files generated by `capture.py`.

```
jackh@maze:~/src/caltech-lwa/ads5296_r2_tests/software$ python loadcsv.py -h
usage: loadcsv.py [-h] [-N N_DUMPS] filename

Write ADC sample data to files

positional arguments:
  filename    File to plot

optional arguments:
  -h, --help  show this help message and exit
  -N N_DUMPS  Number of captures to plot (default: 1)
```

Example Usage:

Plot the first 1024 samples, and 128k-chan spectra of the data in <filename>

```
python loadcsv.py -N 1 <filename>
```

This script will plot multiple ADC channels if they appear in a file.
